<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Design Learning Journey</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .controls {
            background: #f5f5f5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .journey-selector {
            margin: 10px 0;
        }
        .journey-option {
            display: block;
            margin: 5px 0;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            cursor: pointer;
            border-radius: 3px;
        }
        .journey-option.selected {
            background: #007bff;
            color: white;
        }
        .journey-option.unavailable {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        .start-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .lesson-container {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .lesson-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .progress {
            margin: 10px 0;
        }
        .progress-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            margin: 0 5px;
        }
        .progress-dot.completed {
            background: #28a745;
        }
        .progress-dot.current {
            background: #007bff;
        }
        .navigation {
            margin-top: 30px;
            text-align: center;
        }
        .nav-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .learning-goals {
            background: #e8f4f8;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .concept-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            position: relative;
        }
        .exercise {
            background: #fff3cd;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .claude-exercise-btn {
            background: #6f42c1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            display: none;
        }
        .claude-exercise-btn:hover {
            background: #5a359a;
        }
        .claude-section-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #6f42c1;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .claude-section-btn:hover {
            background: #5a359a;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>System Design Learning Journey</h1>
        <h3>Choose Your Learning Journey:</h3>
        <div id="journey-selector" class="journey-selector">
            <div class="loading">Loading available journeys...</div>
        </div>
        <button class="start-btn" onclick="startJourney()">Start Learning Journey</button>
    </div>

    <div id="content" class="hidden">
        <!-- Lesson content will be populated here -->
    </div>

    <!-- Load journey registry first -->
    <script src="journeys/registry.js"></script>

    <script>
        // Global state
        let availableJourneys = {};
        let currentJourneyId = null;
        let currentLessonId = 1;

        // Function to dynamically load all journey JSON files from registry
        async function loadJourneyScripts() {
            // Get the list of journey files from the registry
            const journeyFiles = window.journeyRegistry || [];
            
            if (journeyFiles.length === 0) {
                console.warn('No journey files found in registry');
                return;
            }

            // Initialize journey data object
            window.journeyData = window.journeyData || {};

            const loadPromises = journeyFiles.map(async (filename) => {
                try {
                    const response = await fetch(`journeys/${filename}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const journeyData = await response.json();
                    const journeyId = journeyData.id;
                    
                    // Store the journey data using its ID as the key
                    window.journeyData[journeyId] = journeyData;
                    
                    console.log(`Successfully loaded: ${filename} (${journeyId})`);
                } catch (error) {
                    console.error(`Failed to load journey file: ${filename}`, error);
                }
            });

            await Promise.all(loadPromises);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Load all journey JSON files dynamically
            await loadJourneyScripts();
            
            // Use the externally loaded journey data
            availableJourneys = window.journeyData || {};
            renderJourneySelector();
        });

        function renderJourneySelector() {
            const selector = document.getElementById('journey-selector');
            
            // Get registry order and create journey options in that order
            const registryFiles = window.journeyRegistry || [];
            const journeyOptions = registryFiles.map(filename => {
                // Extract journey ID from filename (remove .json extension)
                const journeyId = filename.replace('.json', '');
                const journey = availableJourneys[journeyId];
                
                // Skip if journey data not loaded
                if (!journey) return '';
                
                const className = journey.available ? 'journey-option' : 'journey-option unavailable';
                const emoji = getJourneyEmoji(journeyId);
                
                return `
                    <div class="${className}" data-journey="${journeyId}">
                        ${emoji} ${journey.title}
                    </div>
                `;
            }).filter(option => option !== '').join('');

            selector.innerHTML = journeyOptions;

            // Add click handlers
            document.querySelectorAll('.journey-option').forEach(option => {
                if (!option.classList.contains('unavailable')) {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.journey-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        currentJourneyId = this.getAttribute('data-journey');
                        currentLessonId = 1;
                    });
                }
            });

            // Select first available journey by default (in registry order)
            const registryFileList = window.journeyRegistry || [];
            const firstAvailable = registryFileList
                .map(filename => filename.replace('.json', ''))
                .find(journeyId => availableJourneys[journeyId] && availableJourneys[journeyId].available);
            
            if (firstAvailable) {
                currentJourneyId = firstAvailable;
                document.querySelector(`[data-journey="${firstAvailable}"]`).classList.add('selected');
            }
        }

        function getJourneyEmoji(journeyId) {
            return '📚';
        }

        function startJourney() {
            if (!currentJourneyId || !availableJourneys[currentJourneyId] || !availableJourneys[currentJourneyId].available) {
                alert('Please select an available journey first!');
                return;
            }
            
            document.getElementById('content').classList.remove('hidden');
            showLesson();
        }

        function showLesson() {
            const journey = availableJourneys[currentJourneyId];
            const lesson = journey.lessons.find(l => l.id === currentLessonId);
            
            if (!lesson) {
                document.getElementById('content').innerHTML = `
                    <div class="lesson-container">
                        <div class="error">Lesson ${currentLessonId} not found!</div>
                    </div>
                `;
                return;
            }

            const progressDots = Array.from({length: journey.totalLessons}, (_, i) => {
                const lessonNum = i + 1;
                let className = 'progress-dot';
                if (lessonNum < currentLessonId) className += ' completed';
                if (lessonNum === currentLessonId) className += ' current';
                return `<span class="${className}"></span>`;
            }).join('');

            const goalsHtml = lesson.goals.map(goal => `<li>${goal}</li>`).join('');

            document.getElementById('content').innerHTML = `
                <div class="lesson-container">
                    <div class="lesson-header">
                        <h2>${lesson.title}</h2>
                        <div class="progress">
                            Progress: ${progressDots} (Lesson ${currentLessonId} of ${journey.totalLessons})
                        </div>
                    </div>

                    <div class="learning-goals">
                        <h3>🎯 What You'll Learn:</h3>
                        <ul>${goalsHtml}</ul>
                    </div>

                    ${lesson.content}

                    <div class="navigation">
                        <button class="nav-btn" onclick="previousLesson()" ${currentLessonId === 1 ? 'disabled' : ''}>
                            ← Previous
                        </button>
                        <span>Lesson ${currentLessonId} of ${journey.totalLessons}</span>
                        <button class="nav-btn" onclick="nextLesson()" ${currentLessonId >= journey.totalLessons ? 'disabled' : ''}>
                            Next →
                        </button>
                        <button id="claude-exercise-btn" class="claude-exercise-btn" onclick="openExerciseInClaude()">
                            💬 Discuss Own Solution with Claude
                        </button>
                    </div>
                </div>
            `;

            // Check if lesson has exercise and show/hide Claude button
            updateClaudeExerciseButton();
            
            // Add question mark buttons to concept sections
            addConceptSectionButtons();
        }

        function nextLesson() {
            const journey = availableJourneys[currentJourneyId];
            if (currentLessonId < journey.totalLessons) {
                currentLessonId++;
                showLesson();
            }
        }

        function previousLesson() {
            if (currentLessonId > 1) {
                currentLessonId--;
                showLesson();
            }
        }

        function updateClaudeExerciseButton() {
            const exerciseDiv = document.querySelector('.exercise');
            const claudeButton = document.getElementById('claude-exercise-btn');
            
            if (exerciseDiv && claudeButton) {
                claudeButton.style.display = 'inline-block';
            } else if (claudeButton) {
                claudeButton.style.display = 'none';
            }
        }

        function extractExerciseText(element) {
            // Create a temporary element to work with
            const temp = element.cloneNode(true);
            
            // Remove any HTML tags and get clean text
            function getTextContent(node) {
                let text = '';
                
                if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Add spacing for block elements
                    if (['DIV', 'P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'BR'].includes(node.tagName)) {
                        text += '\n';
                    }
                    
                    for (let child of node.childNodes) {
                        text += getTextContent(child);
                    }
                    
                    // Add spacing after block elements
                    if (['DIV', 'P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI'].includes(node.tagName)) {
                        text += '\n';
                    }
                }
                
                return text;
            }
            
            return getTextContent(temp)
                .replace(/\n{3,}/g, '\n\n')  // Reduce multiple newlines
                .trim();
        }

        function openExerciseInClaude() {
            const exerciseDiv = document.querySelector('.exercise');

            if (!exerciseDiv) {
                alert('No exercise found in this lesson.');
                return;
            }

            try {
                const journey = availableJourneys[currentJourneyId];
                const currentLesson = journey.lessons.find(l => l.id === currentLessonId);

                // Get previous lesson context
                let previousLessonContext = '';
                if (currentLessonId > 1) {
                    const previousLesson = journey.lessons.find(l => l.id === currentLessonId - 1);
                    if (previousLesson) {
                        const previousTopics = previousLesson.goals || [];
                        if (previousTopics.length > 0) {
                            previousLessonContext = `\n\nPrevious lesson topics covered (${previousLesson.title}):\n` +
                                previousTopics.map(topic => `- ${topic}`).join('\n');
                        }
                    }
                }

                // Extract full lesson content (excluding exercise)
                const lessonContainer = document.querySelector('.lesson-container');
                let fullLessonContent = '';

                if (lessonContainer) {
                    // Clone the container and remove exercise and navigation sections
                    const tempContainer = lessonContainer.cloneNode(true);

                    // Remove exercise sections
                    tempContainer.querySelectorAll('.exercise').forEach(el => el.remove());

                    // Remove navigation section
                    tempContainer.querySelectorAll('.navigation').forEach(el => el.remove());

                    // Remove Claude section buttons
                    tempContainer.querySelectorAll('.claude-section-btn').forEach(el => el.remove());

                    fullLessonContent = extractExerciseText(tempContainer);
                }

                const exerciseText = extractExerciseText(exerciseDiv);

                if (!exerciseText.trim()) {
                    alert('Could not extract exercise text.');
                    return;
                }

                // Construct the full context message
                let contextMessage = `My students are working through a system design learning journey. Here is the current lesson content:\n\n--- CURRENT LESSON CONTENT ---\n${fullLessonContent}`;

                if (previousLessonContext) {
                    contextMessage += previousLessonContext;
                }

                contextMessage += `\n\n--- EXERCISE FOR DISCUSSION ---\n${exerciseText}\n--- EXERCISE FOR DISCUSSION END ---\n==============\nThis is an answer to this exercise in System Design. Review it and provide feedback. Focus mostly on the points that were learning in this lesson, taking into account the content from the previous lessons:`;

                // URL encode the full message
                const encodedText = encodeURIComponent(contextMessage);

                // Create Claude URL
                const claudeUrl = `https://claude.ai/new?q=${encodedText}`;

                // Open in new tab
                window.open(claudeUrl, '_blank');

            } catch (error) {
                console.error('Error opening exercise in Claude:', error);
                alert('Error opening exercise in Claude. Please try again.');
            }
        }

        function addConceptSectionButtons() {
            const conceptSections = document.querySelectorAll('.concept-section');
            
            conceptSections.forEach((section, index) => {
                // Check if button already exists to avoid duplicates
                if (!section.querySelector('.claude-section-btn')) {
                    const button = document.createElement('button');
                    button.className = 'claude-section-btn';
                    button.innerHTML = '?';
                    button.title = 'Discuss this section with Claude';
                    button.onclick = () => openSectionInClaude(section, index);
                    section.appendChild(button);
                }
            });
        }

        function openSectionInClaude(sectionElement, sectionIndex) {
            try {
                // Get the current lesson title for context
                const journey = availableJourneys[currentJourneyId];
                const lesson = journey.lessons.find(l => l.id === currentLessonId);
                const lessonTitle = lesson ? lesson.title : 'Unknown Lesson';
                
                // Extract text content from the section
                const sectionText = extractExerciseText(sectionElement);
                
                if (!sectionText.trim()) {
                    alert('Could not extract section text.');
                    return;
                }
                
                // Create the prefix text with lesson topic
                const prefixText = `The following text is a part of study material on the topic "${lessonTitle}".\n\n`;
                const fullText = prefixText + "```" + sectionText + "```";
                
                // URL encode the text
                const encodedText = encodeURIComponent(fullText);
                
                // Create Claude URL
                const claudeUrl = `https://claude.ai/new?q=${encodedText}`;
                
                // Open in new tab
                window.open(claudeUrl, '_blank');
                
            } catch (error) {
                console.error('Error opening section in Claude:', error);
                alert('Error opening section in Claude. Please try again.');
            }
        }

        // Quiz functions for lesson 6
        function revealAnswers() {
            let totalQuestions = 8;
            let correctAnswers = 0;
            let totalPossiblePoints = 0;
            let earnedPoints = 0;
            
            for (let q = 1; q <= totalQuestions; q++) {
                let questionInputs = document.querySelectorAll(`input[data-question="${q}"]`);
                let questionCorrect = true;
                let questionPoints = 0;
                let maxQuestionPoints = 0;
                
                questionInputs.forEach(input => {
                    let isCorrect = input.dataset.correct === 'true';
                    let isChecked = input.checked;
                    
                    if (isCorrect) maxQuestionPoints++;
                    
                    if (isCorrect && isChecked) {
                        // Correct answer selected
                        input.parentElement.style.background = '#d4edda';
                        input.parentElement.style.color = '#155724';
                        input.parentElement.innerHTML += ' ✅';
                        questionPoints++;
                    } else if (isCorrect && !isChecked) {
                        // Correct answer not selected
                        input.parentElement.style.background = '#fff3cd';
                        input.parentElement.style.color = '#856404';
                        input.parentElement.innerHTML += ' ✅ (missed)';
                        questionCorrect = false;
                    } else if (!isCorrect && isChecked) {
                        // Incorrect answer selected
                        input.parentElement.style.background = '#f8d7da';
                        input.parentElement.style.color = '#721c24';
                        input.parentElement.innerHTML += ' ❌';
                        questionCorrect = false;
                    } else {
                        // Incorrect answer not selected (good)
                        input.parentElement.style.color = '#6c757d';
                    }
                    
                    input.disabled = true;
                });
                
                totalPossiblePoints += maxQuestionPoints;
                earnedPoints += questionPoints;
                
                if (questionCorrect) correctAnswers++;
            }
            
            // Calculate scores
            let percentageScore = Math.round((earnedPoints / totalPossiblePoints) * 100);
            let perfectQuestions = correctAnswers;
            
            // Show results
            document.getElementById('results').style.display = 'block';
            document.getElementById('score-display').innerHTML = `
                <h4>Score: ${earnedPoints}/${totalPossiblePoints} points (${percentageScore}%)</h4>
                <p>Perfect questions: ${perfectQuestions}/${totalQuestions}</p>
            `;
            
            // Provide feedback
            let feedback = '';
            if (percentageScore >= 90) {
                feedback = '🎉 <strong>Excellent!</strong> You have mastered database sharding concepts. You\'re ready to design and implement sharding strategies in real-world systems.';
            } else if (percentageScore >= 75) {
                feedback = '👍 <strong>Great job!</strong> You have a solid understanding of database sharding. Review the areas you missed and you\'ll be ready for complex implementations.';
            } else if (percentageScore >= 60) {
                feedback = '📚 <strong>Good progress!</strong> You understand the fundamentals but should review the lessons focusing on the questions you missed.';
            } else {
                feedback = '🔄 <strong>Keep learning!</strong> Consider reviewing the lessons again, especially focusing on the practical examples and case studies.';
            }
            
            document.getElementById('feedback').innerHTML = feedback;
            document.getElementById('revealBtn').style.display = 'none';
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function retakeQuiz() {
            // Reset all inputs and styling
            let allInputs = document.querySelectorAll('input[type="checkbox"]');
            allInputs.forEach(input => {
                input.checked = false;
                input.disabled = false;
                input.parentElement.style.background = '';
                input.parentElement.style.color = '';
                // Remove checkmarks and x marks
                input.parentElement.innerHTML = input.parentElement.innerHTML.replace(/ ✅| ✅ \(missed\)| ❌/g, '');
            });
            
            // Hide results and show reveal button
            document.getElementById('results').style.display = 'none';
            document.getElementById('revealBtn').style.display = 'inline-block';
            
            // Scroll back to top of quiz
            document.querySelector('.quiz-container').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>